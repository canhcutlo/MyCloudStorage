@using CloudStorage.Models
@{
    ViewData["Title"] = "Document Preview";
    var item = ViewBag.Item as StorageItem;
}

<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-md-3 bg-light border-end d-flex flex-column" style="height: calc(100vh - 56px);">
            <div class="p-3 border-bottom">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt"></i> Document Info
                </h5>
            </div>
            
            <div class="p-3 flex-grow-1 overflow-auto">
                <div class="mb-3">
                    <h6 class="text-muted mb-2">File Name</h6>
                    <p class="mb-0 text-break" id="fileName">@item?.Name</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-muted mb-2">File Type</h6>
                    <p class="mb-0" id="fileType">
                        <span class="badge bg-info" id="fileTypeBadge">Loading...</span>
                    </p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-muted mb-2">Size</h6>
                    <p class="mb-0">@(item?.Size != null ? FormatFileSize((long)item.Size) : "N/A")</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-muted mb-2">Created</h6>
                    <p class="mb-0">@item?.CreatedAt.ToString("MMM dd, yyyy HH:mm")</p>
                </div>
                
                <div class="mb-3" id="metadataSection" style="display: none;">
                    <h6 class="text-muted mb-2">Metadata</h6>
                    <div id="metadataContent"></div>
                </div>
                
                <div class="mb-3" id="pagesInfo" style="display: none;">
                    <h6 class="text-muted mb-2">Pages</h6>
                    <p class="mb-0" id="pageCount">-</p>
                </div>
                
                <hr />
                
                <div class="d-grid gap-2">
                    <a href="@Url.Action("Download", "Preview", new { id = item?.Id })" class="btn btn-primary">
                        <i class="fas fa-download"></i> Download
                    </a>
                    <a href="@Url.Action("Index", "Storage", new { folderId = item?.ParentFolderId })" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Files
                    </a>
                </div>
            </div>
        </div>

        <!-- Preview Area -->
        <div class="col-md-9 d-flex flex-column p-0" style="height: calc(100vh - 56px);">
            <!-- Toolbar -->
            <div class="bg-white border-bottom p-3 d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="zoomOut">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <span class="mx-2" id="zoomLevel">100%</span>
                    <button class="btn btn-sm btn-outline-secondary" id="zoomIn">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
                
                <div id="pageNavigation" style="display: none;">
                    <button class="btn btn-sm btn-outline-secondary" id="prevPage" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="mx-2">
                        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </span>
                    <button class="btn btn-sm btn-outline-secondary" id="nextPage">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="toggleText" title="Toggle Text/Image View">
                        <i class="fas fa-exchange-alt"></i> View Mode
                    </button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div class="flex-grow-1 d-flex justify-content-center align-items-center" id="loadingSpinner">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading preview...</p>
                </div>
            </div>

            <!-- Error Message -->
            <div class="flex-grow-1 d-flex justify-content-center align-items-center" id="errorMessage" style="display: none;">
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5 id="errorText">Error loading preview</h5>
                </div>
            </div>

            <!-- Preview Content -->
            <div class="flex-grow-1 overflow-auto bg-secondary bg-opacity-10 p-4" id="previewContainer" style="display: none;">
                <div class="preview-content bg-white shadow-sm mx-auto" id="previewContent" style="max-width: 900px; transition: transform 0.2s;">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

@section Scripts {
    <script>
        let previewData = null;
        let currentPageIndex = 0;
        let zoomLevel = 100;
        let viewMode = 'text'; // 'text' or 'image'

        $(document).ready(function() {
            loadPreview();

            // Zoom controls
            $('#zoomIn').click(function() {
                zoomLevel = Math.min(200, zoomLevel + 10);
                applyZoom();
            });

            $('#zoomOut').click(function() {
                zoomLevel = Math.max(50, zoomLevel - 10);
                applyZoom();
            });

            // Page navigation
            $('#prevPage').click(function() {
                if (currentPageIndex > 0) {
                    currentPageIndex--;
                    showPage(currentPageIndex);
                }
            });

            $('#nextPage').click(function() {
                if (currentPageIndex < previewData.totalPages - 1) {
                    currentPageIndex++;
                    showPage(currentPageIndex);
                }
            });

            // View mode toggle
            $('#toggleText').click(function() {
                viewMode = viewMode === 'text' ? 'image' : 'text';
                showPage(currentPageIndex);
            });
        });

        function loadPreview() {
            const itemId = @item?.Id;
            console.log('Loading preview for item ID:', itemId);
            
            $.ajax({
                url: '@Url.Action("GetPreview", "Preview")',
                type: 'GET',
                data: { id: itemId, maxPages: 20 },
                success: function(response) {
                    console.log('Preview response:', response);
                    console.log('response.success is:', response.success, typeof response.success);
                    if (response.success) {
                        console.log('Success condition met, setting previewData and calling displayPreview');
                        previewData = response;
                        try {
                            displayPreview(response);
                        } catch (err) {
                            console.error('Error in displayPreview:', err);
                            showError('Error displaying preview: ' + err.message);
                        }
                    } else {
                        console.error('Preview failed:', response.error);
                        showError(response.error || 'Failed to load preview');
                    }
                },
                error: function(xhr) {
                    console.error('AJAX error:', xhr.status, xhr.statusText, xhr.responseJSON);
                    let errorMsg = 'Failed to load preview';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    } else if (xhr.status === 404) {
                        errorMsg = 'File not found (404)';
                    } else if (xhr.status === 403) {
                        errorMsg = 'Access denied (403)';
                    } else if (xhr.status === 401) {
                        errorMsg = 'Not authenticated (401)';
                    } else if (xhr.statusText) {
                        errorMsg = `Error: ${xhr.statusText} (${xhr.status})`;
                    }
                    showError(errorMsg);
                }
            });
        }

        function displayPreview(data) {
            console.log('Displaying preview data:', data);
            $('#loadingSpinner').addClass('d-none');
            $('#errorMessage').addClass('d-none');
            $('#previewContainer').removeClass('d-none').css('display', 'flex');

            // Update file type
            if (data.fileType) {
                $('#fileTypeBadge').text(data.fileType.toUpperCase());
            } else {
                console.warn('No fileType in response');
            }

            // Update metadata
            if (data.metadata && Object.keys(data.metadata).length > 0) {
                $('#metadataSection').removeClass('d-none');
                let metadataHtml = '<div class="small">';
                for (let key in data.metadata) {
                    metadataHtml += `<div class="mb-1"><strong>${key}:</strong> ${data.metadata[key]}</div>`;
                }
                metadataHtml += '</div>';
                $('#metadataContent').html(metadataHtml);
            }

            // Update page info
            if (data.totalPages > 1) {
                $('#pagesInfo').removeClass('d-none');
                $('#pageNavigation').removeClass('d-none');
                $('#pageCount').text(data.totalPages);
                $('#totalPages').text(data.totalPages);
            } else {
                $('#pagesInfo').removeClass('d-none');
                $('#pageCount').text('1');
            }

            // Show first page
            showPage(0);
        }

        function showPage(pageIndex) {
            console.log('showPage called with index:', pageIndex, 'previewData:', previewData);
            
            if (!previewData) {
                console.error('No preview data available');
                return;
            }

            // Handle documents without pages array (e.g., single page images or text)
            if (!previewData.pages || previewData.pages.length === 0) {
                console.log('No pages array, checking for content or single image');
                
                // Check if there's direct content (plain text)
                if (previewData.content) {
                    console.log('Displaying direct content');
                    $('#previewContent').html(`<div class="p-4"><pre class="text-wrap">${escapeHtml(previewData.content)}</pre></div>`);
                    return;
                }
                
                console.warn('No pages and no content found in preview data');
                return;
            }

            const page = previewData.pages[pageIndex];
            console.log('Page data:', page);
            console.log('page.imageBase64 exists:', !!page.imageBase64);
            console.log('page.content exists:', !!page.content);
            console.log('page.content length:', page.content ? page.content.length : 0);
            
            if (!page) {
                console.error('Page not found at index:', pageIndex);
                return;
            }

            currentPageIndex = pageIndex;
            $('#currentPage').text(pageIndex + 1);

            // Update navigation buttons
            $('#prevPage').prop('disabled', pageIndex === 0);
            $('#nextPage').prop('disabled', pageIndex === previewData.totalPages - 1);

            // Display content based on view mode and available data
            let contentHtml = '';
            
            if (page.imageBase64 && (viewMode === 'image' || !page.content)) {
                console.log('Rendering image, base64 length:', page.imageBase64.length);
                // Show image
                contentHtml = `<div class="p-4 text-center">
                    <img src="data:image/png;base64,${page.imageBase64}" 
                         class="img-fluid" 
                         alt="Page ${page.pageNumber}" 
                         style="max-width: 100%;" />
                </div>`;
                
                if (page.content) {
                    contentHtml += `<div class="p-4 border-top">
                        <h6 class="text-muted mb-2">Extracted Text (OCR):</h6>
                        <pre class="text-wrap small">${escapeHtml(page.content)}</pre>
                    </div>`;
                }
            } else if (page.content) {
                console.log('Rendering text content');
                // Show text
                contentHtml = `<div class="p-4">
                    <pre class="text-wrap">${escapeHtml(page.content)}</pre>
                </div>`;
            } else {
                console.error('No content to display - no imageBase64 and no content');
            }

            console.log('Setting content HTML, length:', contentHtml.length);
            $('#previewContent').html(contentHtml);
            console.log('Content set, calling applyZoom');
            applyZoom();
        }

        function applyZoom() {
            $('#zoomLevel').text(zoomLevel + '%');
            $('#previewContent').css('transform', `scale(${zoomLevel / 100})`);
            $('#previewContent').css('transform-origin', 'top center');
        }

        function showError(message) {
            $('#loadingSpinner').addClass('d-none');
            $('#errorMessage').removeClass('d-none');
            $('#errorText').text(message);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>

    <style>
        .preview-content {
            min-height: 800px;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
        }

        #previewContainer::-webkit-scrollbar {
            width: 12px;
        }

        #previewContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #previewContainer::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }

        #previewContainer::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
}
